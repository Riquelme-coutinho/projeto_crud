<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo da MemÃ³ria - EducaTech</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/jogo_memoria.css">
    <link rel="icon" href="/img/logo-educatech.svg" type="image/svg+xml">
</head>

<body>
    <div class="container-lg">
        <div class="card">
            <div class="game-header">
                <h2>ðŸ§  Jogo da MemÃ³ria</h2>
                <a href="/jogos" class="btn btn-secondary btn-small">Voltar</a>
            </div>

            <div class="game-stats">
                <div>Movimentos: <span id="moves">0</span></div>
                <div>Tempo: <span id="timer">00:00</span></div>
            </div>

            <div class="memory-game" id="memory-game">
                <!-- Cards will be injected here by JS -->
            </div>

            <div id="win-message" class="hidden win-message">
                <h3>ParabÃ©ns! VocÃª venceu! ðŸŽ‰</h3>
                <button onclick="restartGame()" class="btn btn-primary mt-2">Jogar Novamente</button>
            </div>
        </div>
    </div>

    <script>
        // Cards data from server
        const cardsData = <% - JSON.stringify(cards) %>;

        const gameBoard = document.getElementById('memory-game');
        const movesDisplay = document.getElementById('moves');
        const timerDisplay = document.getElementById('timer');
        const winMessage = document.getElementById('win-message');

        let hasFlippedCard = false;
        let lockBoard = false;
        let firstCard, secondCard;
        let moves = 0;
        let timer;
        let seconds = 0;
        let gameStarted = false;
        let matches = 0;

        function initGame() {
            // Duplicate and shuffle
            const gameCards = [...cardsData, ...cardsData];
            gameCards.sort(() => 0.5 - Math.random());

            gameBoard.innerHTML = '';
            gameCards.forEach(card => {
                const cardElement = document.createElement('div');
                cardElement.classList.add('memory-card');
                cardElement.dataset.framework = card.name;

                cardElement.innerHTML = `
                    <div class="front-face">${card.icon}</div>
                    <div class="back-face">?</div>
                `;

                cardElement.addEventListener('click', flipCard);
                gameBoard.appendChild(cardElement);
            });

            resetBoard();
            moves = 0;
            seconds = 0;
            matches = 0;
            movesDisplay.innerText = moves;
            timerDisplay.innerText = '00:00';
            winMessage.classList.add('hidden');
            clearInterval(timer);
            gameStarted = false;
        }

        function startTimer() {
            if (!gameStarted) {
                gameStarted = true;
                timer = setInterval(() => {
                    seconds++;
                    const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
                    const secs = (seconds % 60).toString().padStart(2, '0');
                    timerDisplay.innerText = `${mins}:${secs}`;
                }, 1000);
            }
        }

        function flipCard() {
            if (lockBoard) return;
            if (this === firstCard) return;

            startTimer();

            this.classList.add('flip');

            if (!hasFlippedCard) {
                hasFlippedCard = true;
                firstCard = this;
                return;
            }

            secondCard = this;
            checkForMatch();
        }

        function checkForMatch() {
            moves++;
            movesDisplay.innerText = moves;

            let isMatch = firstCard.dataset.framework === secondCard.dataset.framework;

            isMatch ? disableCards() : unflipCards();
        }

        function disableCards() {
            firstCard.removeEventListener('click', flipCard);
            secondCard.removeEventListener('click', flipCard);

            matches++;
            if (matches === cardsData.length) {
                clearInterval(timer);
                setTimeout(() => {
                    winMessage.classList.remove('hidden');
                }, 500);
            }

            resetBoard();
        }

        function unflipCards() {
            lockBoard = true;

            setTimeout(() => {
                firstCard.classList.remove('flip');
                secondCard.classList.remove('flip');

                resetBoard();
            }, 1000);
        }

        function resetBoard() {
            [hasFlippedCard, lockBoard] = [false, false];
            [firstCard, secondCard] = [null, null];
        }

        function restartGame() {
            initGame();
        }

        initGame();
    </script>
</body>

</html>